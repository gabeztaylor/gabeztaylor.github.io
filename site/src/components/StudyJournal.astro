---
import { computeStudyTagIndex, loadStudyJournalDays } from "../lib/studyJournalContent.js";

const {
  showHero = false,
  heroKicker = "Daily",
  heroTitle = "Study Journal",
  heroSubtitle = "What I’m studying these days",
} = Astro.props;

const days = loadStudyJournalDays();
const tagIndex = computeStudyTagIndex(days);
const dayByISO = new Map(days.map((d) => [d.dateISO, d]));

function formatMinutes(totalMinutes) {
  const mins = Math.max(0, Math.round(Number(totalMinutes) || 0));
  if (mins < 60) return `${mins}m`;
  const h = Math.floor(mins / 60);
  const m = mins % 60;
  return m === 0 ? `${h}h` : `${h}h ${m}m`;
}

function toISODateLocal(d) {
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  return `${y}-${m}-${day}`;
}

function startOfWeekMondayLocal(now) {
  const d = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0, 0);
  const dow = d.getDay(); // 0..6 (Sun..Sat)
  const delta = (dow + 6) % 7; // days since Monday
  d.setDate(d.getDate() - delta);
  return d;
}

const weekStart = startOfWeekMondayLocal(new Date());
const weekStartISO = toISODateLocal(weekStart);
const weekEnd = new Date(weekStart.getFullYear(), weekStart.getMonth(), weekStart.getDate() + 7, 0, 0, 0, 0);
const weekEndISO = toISODateLocal(weekEnd);

const weekDays = days.filter((d) => d.dateISO >= weekStartISO && d.dateISO < weekEndISO);
const weekTagIndex = computeStudyTagIndex(weekDays);

const weekTotalMinutes = weekDays.reduce(
  (acc, d) => acc + d.sessions.reduce((a, s) => a + (Number(s.durationMinutes) || 0), 0),
  0,
);

const topTagsAll = [...(tagIndex.tags || [])]
  .sort((a, b) => (Number(b.totalMinutes) || 0) - (Number(a.totalMinutes) || 0))
  .slice(0, 5);
const topMaxMinutesAll = topTagsAll.length > 0 ? (Number(topTagsAll[0]?.totalMinutes) || 0) : 0;

const topTagsWeek = [...(weekTagIndex.tags || [])]
  .sort((a, b) => (Number(b.totalMinutes) || 0) - (Number(a.totalMinutes) || 0))
  .slice(0, 5);
const topMaxMinutesWeek = topTagsWeek.length > 0 ? (Number(topTagsWeek[0]?.totalMinutes) || 0) : 0;

function escapeHtml(s) {
  return String(s || "")
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#39;");
}

function renderInline(s) {
  // Minimal safe inline formatting for notes/sources.
  let out = escapeHtml(s);
  out = out.replace(/\*\*([^*]+)\*\*/g, "<strong>$1</strong>");
  out = out.replace(
    /(https?:\/\/[^\s<]+)/g,
    '<a href="$1" target="_blank" rel="noreferrer">$1</a>',
  );
  return out;
}
---

{showHero && (
  <section class="hero card">
    <div class="inner">
      <div class="heroText">
        <div class="kicker pill">{heroKicker}</div>
        <h1>{heroTitle}</h1>
        <p class="muted">{heroSubtitle}</p>
        <div class="cta">
          <a class="btn primary" href="#tag-index">Browse by tag</a>
        </div>
      </div>

      {(topTagsWeek.length > 0 || topTagsAll.length > 0) && (
        <aside class="topChart" aria-label="Top studied subjects">
          <div class="chartHead">
            <div class="chartTitle">Top subjects</div>
            <div class="chartFilters" role="group" aria-label="Time filter">
              <button class="chip active" type="button" data-chart="week">This week</button>
              <button class="chip" type="button" data-chart="all">All time</button>
            </div>
          </div>

          <div class="chartHint muted">
            <span class="mono">Week of {weekStartISO}</span>
            <span class="sep">·</span>
            <span>{formatMinutes(weekTotalMinutes)} total</span>
          </div>

          <ol class="chartList" data-chart-panel="week">
            {topTagsWeek.map((t, i) => {
              const mins = Number(t.totalMinutes) || 0;
              const w = topMaxMinutesWeek > 0 ? Math.max(3, Math.round((mins / topMaxMinutesWeek) * 100)) : 0;
              const hue = `${(i * 42) % 360}deg`;
              return (
                <li class="chartRow">
                  <a class="chartTag" href={`#tag-${t.tag}`}>#{t.tag}</a>
                  <div class="chartBar" style={`--w:${w}%;--hue:${hue};`} title={`${t.totalLabel}`}>
                    <div class="chartFill" />
                  </div>
                  <div class="chartValue">{t.totalLabel}</div>
                </li>
              );
            })}
          </ol>

          <ol class="chartList hidden" data-chart-panel="all">
            {topTagsAll.map((t, i) => {
              const mins = Number(t.totalMinutes) || 0;
              const w = topMaxMinutesAll > 0 ? Math.max(3, Math.round((mins / topMaxMinutesAll) * 100)) : 0;
              const hue = `${(i * 42) % 360}deg`;
              return (
                <li class="chartRow">
                  <a class="chartTag" href={`#tag-${t.tag}`}>#{t.tag}</a>
                  <div class="chartBar" style={`--w:${w}%;--hue:${hue};`} title={`${t.totalLabel}`}>
                    <div class="chartFill" />
                  </div>
                  <div class="chartValue">{t.totalLabel}</div>
                </li>
              );
            })}
          </ol>
        </aside>
      )}
    </div>
  </section>
)}

<section class="card page">
  <div class="content">
    {days.length === 0 ? (
      <p class="muted" style="margin-top: 18px;">No study sessions yet.</p>
    ) : (
      days.map((d) => (
        <section class="study-day">
          <h3 id={d.id}>{d.longDate || d.mdDate}</h3>
          <ul>
            {d.sessions.map((s) => (
              <li>
                <div class="sessionHead">
                  <div class="sessionText">
                    <strong>{s.startLabel} – {s.endLabel}</strong> ({s.durationLabel}): {s.description}
                  </div>
                  {s.tags.length > 0 && (
                    <div class="sessionTags" aria-label="Tags">
                      {s.tags.map((tag) => (
                        <a class="tagChip" href={`#tag-${tag}`}>#{tag}</a>
                      ))}
                    </div>
                  )}
                </div>
                {(s.tags.length > 0 || s.sources.length > 0 || s.notes.length > 0 || s.screenshots.length > 0) && (
                  <ul>
                    {s.sources.length > 0 && (
                      <li>
                        <strong>Sources</strong>
                        <ul>
                          {s.sources.map((src) => (
                            <li><span set:html={renderInline(src)} /></li>
                          ))}
                        </ul>
                      </li>
                    )}
                    {s.notes.length > 0 && (
                      <li>
                        <strong>Notes</strong>
                        <ul>
                          {s.notes.map((n) => (
                            <li><span set:html={renderInline(n)} /></li>
                          ))}
                        </ul>
                      </li>
                    )}
                    {s.screenshots.length > 0 && (
                      <li>
                        <strong>Screenshots</strong>
                        <ul>
                          {s.screenshots.map((u) => (
                            <li><img src={u} alt="" loading="lazy" /></li>
                          ))}
                        </ul>
                      </li>
                    )}
                  </ul>
                )}
              </li>
            ))}
          </ul>
        </section>
      ))
    )}

    <div class="tagSection" id="tag-index">
      <div class="row space">
        <h2>Tags</h2>
        <div class="muted" style="font-size: 13px;">Browse days by topic</div>
      </div>

      {tagIndex.tags.length === 0 ? (
        <p class="muted" style="margin-top: 10px;">No tags yet.</p>
      ) : (
        tagIndex.tags.map((t) => (
          <details class="tagGroup" id={t.id}>
            <summary>
              <span class="tagTitle">#{t.tag}</span>
              <span class="tagMeta">
                <span class="tagTotal">{t.totalLabel}</span>
                <span class="tagCount">{t.dayCount}</span>
              </span>
            </summary>
            <ul>
              {t.dateISOs.map((dateISO) => {
                const d = dayByISO.get(dateISO);
                if (!d) return null;
                return (
                  <li>
                    <a href={`#${d.id}`}>{d.mdDate}</a>
                  </li>
                );
              })}
            </ul>
          </details>
        ))
      )}
    </div>
  </div>
</section>

<style>
  .hero { padding: 18px; }
  .hero .inner { display: grid; gap: 14px; padding: 12px; align-items: start; }
  .heroText { display: grid; gap: 12px; }
  .kicker { width: fit-content; font-weight: 800; font-size: 12px; color: var(--muted); }
  .cta { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 6px; }

  .topChart {
    border: 1px solid var(--border);
    background: color-mix(in oklab, var(--surface2) 70%, transparent);
    border-radius: 14px;
    padding: 12px;
  }
  .chartHead { display: flex; align-items: baseline; justify-content: space-between; gap: 10px; }
  .chartTitle {
    font-weight: 950;
    font-size: 13px;
    color: var(--muted);
    letter-spacing: 0.02em;
  }
  .chartFilters { display: inline-flex; gap: 8px; flex-wrap: wrap; justify-content: flex-end; }
  .chartFilters .chip {
    border: 1px solid var(--border);
    background: var(--surface);
    color: var(--muted);
    font-weight: 850;
    font-size: 12px;
    padding: 6px 10px;
    border-radius: 999px;
    cursor: pointer;
  }
  .chartFilters .chip.active {
    color: var(--text);
    border-color: color-mix(in oklab, var(--accent) 35%, var(--border));
  }
  .chartHint { margin-top: 8px; font-size: 12px; display: flex; flex-wrap: wrap; gap: 8px; align-items: baseline; }
  .chartHint .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  .chartHint .sep { opacity: 0.6; }

  .hidden { display: none; }
  .muted { color: var(--muted); }

  .chartList { list-style: none; padding: 0; margin: 0; display: grid; gap: 10px; }
  .chartList { margin-top: 10px; }
  .chartList.hidden { display: none; }
  .chartRow {
    display: grid;
    grid-template-columns: 120px 1fr 70px;
    align-items: center;
    gap: 10px;
    min-width: 0;
  }
  .chartTag {
    display: block;
    text-decoration: none;
    color: var(--text);
    font-weight: 900;
    font-size: 13px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .chartTag:hover { color: var(--accent); }
  .chartValue {
    color: var(--muted);
    font-weight: 850;
    font-size: 12px;
    white-space: nowrap;
    text-align: right;
  }
  .chartBar {
    height: 10px;
    border-radius: 999px;
    border: 1px solid var(--border);
    background: color-mix(in oklab, var(--surface) 65%, transparent);
    overflow: hidden;
  }
  .chartFill {
    height: 100%;
    width: var(--w);
    background: linear-gradient(
      90deg,
      color-mix(in oklab, var(--accent) 85%, transparent),
      color-mix(in oklab, var(--accent) 60%, transparent)
    );
    filter: hue-rotate(var(--hue));
  }

  @media (min-width: 740px) {
    .hero .inner { grid-template-columns: 1.2fr 1fr; }
    .topChart { margin-top: 6px; }
  }

  .page { padding: 18px; }
  .content :global(.study-day) {
    margin: 16px 0;
    overflow: hidden;
    padding: 14px 16px;
    border: 1px solid var(--border);
    border-radius: 14px;
    background: color-mix(in oklab, var(--surface2) 70%, transparent);
  }
  .content :global(.study-day h3) {
    margin: 0 0 10px 0;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--border);
  }
  .content :global(.study-day ul) { margin-top: 10px; }
  .content :global(.study-day > ul) { margin-bottom: 0; }
  .content :global(.study-day img) {
    max-width: 100%;
    height: auto;
    display: block;
    border-radius: 14px;
    border: 1px solid var(--border);
    background: var(--surface);
  }

  .content :global(.sessionHead) {
    display: flex;
    align-items: baseline;
    justify-content: space-between;
    gap: 10px;
    flex-wrap: wrap;
  }
  .content :global(.sessionTags) {
    display: inline-flex;
    gap: 8px;
    flex-wrap: wrap;
    justify-content: flex-end;
  }
  .content :global(a.tagChip) {
    display: inline-flex;
    padding: 6px 10px;
    border-radius: 999px;
    border: 1px solid var(--border);
    background: var(--surface);
    text-decoration: none;
    color: var(--muted);
    font-weight: 850;
    font-size: 12px;
    line-height: 1;
    white-space: nowrap;
  }
  .content :global(a.tagChip:hover) {
    color: var(--text);
    border-color: color-mix(in oklab, var(--accent) 35%, var(--border));
  }

  .content :global(.tagSection) {
    margin-top: 22px;
    padding-top: 18px;
    border-top: 1px solid var(--border);
  }
  .content :global(.row) { display: flex; align-items: baseline; gap: 10px; }
  .content :global(.space) { justify-content: space-between; }

  .content :global(details.tagGroup) {
    border: 1px solid var(--border);
    border-radius: 14px;
    background: var(--surface);
    padding: 10px 12px;
    margin: 12px 0;
  }
  .content :global(details.tagGroup summary) {
    list-style: none;
    cursor: pointer;
    display: flex;
    align-items: baseline;
    justify-content: space-between;
    gap: 10px;
    font-weight: 900;
    color: var(--text);
    padding: 6px 4px;
  }
  .content :global(details.tagGroup summary::-webkit-details-marker) { display: none; }
  .content :global(.tagTitle) { font-size: 16px; }
  .content :global(.tagMeta) { display: inline-flex; gap: 8px; align-items: center; }
  .content :global(.tagTotal),
  .content :global(.tagCount) {
    font-size: 12px;
    color: var(--muted);
    border: 1px solid var(--border);
    background: var(--surface2);
    padding: 4px 8px;
    border-radius: 999px;
    white-space: nowrap;
  }
  .content :global(details.tagGroup[open] ul) { margin-top: 10px; }
</style>

<script is:inline>
  (function () {
    const root = document;
    const chart = root.querySelector(".topChart");
    if (!chart) return;
    const buttons = Array.from(chart.querySelectorAll(".chartFilters .chip"));
    const panels = {
      week: chart.querySelector('[data-chart-panel="week"]'),
      all: chart.querySelector('[data-chart-panel="all"]'),
    };

    function set(which) {
      for (const b of buttons) b.classList.toggle("active", b.getAttribute("data-chart") === which);
      if (panels.week) panels.week.classList.toggle("hidden", which !== "week");
      if (panels.all) panels.all.classList.toggle("hidden", which !== "all");
    }

    for (const b of buttons) {
      b.addEventListener("click", () => set(b.getAttribute("data-chart") || "week"));
    }

    set("week");
  })();
</script>

<script is:inline>
  function openIfTagHash() {
    const hash = location.hash || "";
    if (!hash.startsWith("#tag-")) return;
    const el = document.getElementById(hash.slice(1));
    if (el && el.tagName === "DETAILS") {
      el.open = true;
      setTimeout(() => el.scrollIntoView({ block: "start" }), 0);
    }
  }
  window.addEventListener("hashchange", openIfTagHash);
  openIfTagHash();
</script>

